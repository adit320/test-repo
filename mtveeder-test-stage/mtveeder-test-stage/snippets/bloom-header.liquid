{% comment %}
This shop uses Bloom, a growth platform for modern wineries.
You SHOULD NOT modify the contents of this file.
It is automatically generated and your changes will be overwritten.
These features and content can be managed within the Bloom app or the Shopify customizer.

Bloom (www.bloom.wine)
{% endcomment %}

<link href="https://bloomapp-production.herokuapp.com/assets/uikit/css/uikit.min.css" rel="stylesheet" type="text/css" media="all" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.20/js/uikit.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.20/js/uikit-icons.min.js"></script>

<script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
<script defer src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>

<script src='https://js.stripe.com/v3/'></script>

<script defer src="{{ 'bloom-storefront-dependencies.js' | asset_url }}"></script>

{% render 'bloom-js-polyfills' %}

<script type="text/javascript">
window.Bloom = window.Bloom || {};
window.Bloom.storefront = window.Bloom.storefront || {};
window.Bloom.storefront.utilities = window.Bloom.storefront.utilities || {};
window.Bloom.storefront.utilities._ = window.Bloom.storefront.utilities._ || {};
// Adapted from https://matthiashager.com/converting-snake-case-to-camel-case-object-keys-with-javascript
Bloom.storefront.utilities._.isArray = function(a) {
  return Array.isArray(a);
};

Bloom.storefront.utilities._.isObject = function(o) {
  return o === Object(o) && !Bloom.storefront.utilities._.isArray(o) && typeof o !== 'function';
};

Bloom.storefront.utilities._.toCamel = function(s) {
  return s.replace(/([-_][a-z])/ig, function($1) {
    return $1.toUpperCase()
      .replace('-', '')
      .replace('_', '');
  });
};

Bloom.storefront.utilities._.keysToCamel = function(o) {
  if (Bloom.storefront.utilities._.isObject(o)) {
    const n = {};

    Object.keys(o)
      .forEach((k) => {
        n[Bloom.storefront.utilities._.toCamel(k)] = Bloom.storefront.utilities._.keysToCamel(o[k]);
      });

    return n;
  } else if (Bloom.storefront.utilities._.isArray(o)) {
    return o.map((i) => {
      return Bloom.storefront.utilities._.keysToCamel(i);
    });
  }

  return o;
};

window.Bloom.storefront.settings = window.Bloom.storefront.settings || {};
window.Bloom.storefront.state = window.Bloom.storefront.state || {};
window.Bloom.storefront.data = window.Bloom.storefront.data || {{ shop.metafields.bloom.bloomfields | json }};
window.Bloom.storefront.data.customer = window.Bloom.storefront.data.customer || {
  id: "{{ customer.id }}",
  firstName: "{{ customer.first_name }}",
  lastName: "{{ customer.last_name }}",
  phone: "{{ customer.phone }}",
  email: "{{ customer.email }}",
  hasAccount: {% if customer %}{{ customer.has_account }}{% else %}null{% endif %},
  addresses: [{% for address in customer.addresses %}{{ address | json }}{% if forloop.last == false %},{% endif %}{% endfor %}],
  tags: "{{ customer.tags | join: ',' }}"
}
window.Bloom.storefront.data.shippingCountries = window.Bloom.storefront.data.shippingCountries || {{ shop.metafields.bloom.shipping_countries | json }};
window.Bloom.storefront.data.clubs = window.Bloom.storefront.data.clubs || {{ shop.metafields.bloom.clubs | json }};
window.Bloom.storefront.data.subscriptionVariants = window.Bloom.storefront.data.subscriptionVariants || {{ shop.metafields.bloom.subscription_variants | json }};

(function() {

  Bloom.storefront.data.products = [{"id":"6753819820209","abv":"14.5","purchase_terms":[]},{"id":"6749365010609","abv":"15.5","purchase_terms":[]},{"id":"6743770497201","abv":null,"purchase_terms":[]},{"id":"6736875585713","abv":"15","purchase_terms":[]},{"id":"6736874340529","abv":"14.5","purchase_terms":[]},{"id":"6709676540081","abv":"14.5","purchase_terms":[]},{"id":"6709675786417","abv":"15.5","purchase_terms":[]},{"id":"6709674705073","abv":"14.5","purchase_terms":[]},{"id":"6709674344625","abv":"14.5","purchase_terms":[]},{"id":"6709673230513","abv":"14.5","purchase_terms":[]},{"id":"6709672050865","abv":"14.5","purchase_terms":[]},{"id":"6709671690417","abv":"13.5","purchase_terms":[]},{"id":"6709671231665","abv":"13.5","purchase_terms":[]},{"id":"6709670805681","abv":"13.5","purchase_terms":[]},{"id":"6709662154929","abv":"14","purchase_terms":[]},{"id":"6709660745905","abv":"14.5","purchase_terms":[]},{"id":"6709660287153","abv":"14.5","purchase_terms":[]},{"id":"6709659336881","abv":"14.5","purchase_terms":[]},{"id":"6709658714289","abv":"14.5","purchase_terms":[]},{"id":"6709656158385","abv":"14.5","purchase_terms":[]},{"id":"6709655142577","abv":"14.5","purchase_terms":[]},{"id":"6709591834801","abv":"14.5","purchase_terms":[]},{"id":"6709563130033","abv":"14.5","purchase_terms":[]},{"id":"6709555888305","abv":"14.5","purchase_terms":[]},{"id":"6709550809265","abv":"14.9","purchase_terms":[]},{"id":"6709546877105","abv":"14.5","purchase_terms":[]},{"id":"6709542158513","abv":"15","purchase_terms":[]},{"id":"6709521449137","abv":"14.5","purchase_terms":[]},{"id":"6709514141873","abv":"8","purchase_terms":[]},{"id":"6709511422129","abv":"14.5","purchase_terms":[]},{"id":"6709501034673","abv":"14.5","purchase_terms":[]},{"id":"6709496447153","abv":"14.5","purchase_terms":[]},{"id":"6709485142193","abv":"14.5","purchase_terms":[]},{"id":"6709401682097","abv":null,"purchase_terms":[]},{"id":"6709212905649","abv":null,"purchase_terms":[]},{"id":"6697845686449","abv":"14.5","purchase_terms":[]},{"id":"6697843228849","abv":"14.5","purchase_terms":[]},{"id":"6697839558833","abv":"13.5","purchase_terms":[]},{"id":"6697836708017","abv":"14.5","purchase_terms":[]},{"id":"6697826222257","abv":"14.5","purchase_terms":[]},{"id":"6697823764657","abv":"14.5","purchase_terms":[]},{"id":"6697819668657","abv":"14.5","purchase_terms":[]},{"id":"6697815179441","abv":"14.5","purchase_terms":[]},{"id":"6697795420337","abv":"14.5","purchase_terms":[]},{"id":"6684285403313","abv":null,"purchase_terms":[{"type":"buy_one_time","variant_id":"39763023265969","price":"99.00","quantity_unit":"item","quantity":1,"quantity_presentment":[{"bottle":0}]},{"type":"subscription","variant_id":"39763023265969","price":99.0,"level_id":112216,"level_name":"Star Shipping","option_id":116147,"option_name":"Star Shipping","frequency_unit":"month","frequency_value":12,"frequency_label":"Yearly","quantity_unit":"item","quantity":1,"quantity_presentment":[{"bottle":0}],"discount_value":0,"discount_type":"percentage"}]},{"id":"6673555259569","abv":"14.5","purchase_terms":[]},{"id":"6673532682417","abv":"14","purchase_terms":[]},{"id":"6673464754353","abv":"14.5","purchase_terms":[]},{"id":"6673448894641","abv":"14.9","purchase_terms":[]},{"id":"6673445486769","abv":"14.5","purchase_terms":[]},{"id":"6673414521009","abv":"14","purchase_terms":[]},{"id":"6624813744305","abv":"14.5","purchase_terms":[]},{"id":"6576003088561","abv":"14.5","purchase_terms":[]},{"id":"6576003023025","abv":"14.5","purchase_terms":[{"type":"buy_one_time","variant_id":"39355981758641","price":"34.00","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}]},{"type":"buy_one_time","variant_id":"39355981758641","price":"34.00","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}]},{"type":"buy_one_time","variant_id":"39355981758641","price":"34.00","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}]},{"type":"buy_one_time","variant_id":"39355981758641","price":"34.00","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}]},{"type":"subscription","variant_id":"39355981758641","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115774,"option_name":"Robert Mondavi Winery Sauvignon Blanc Stags Leap District Napa Valley 2019","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355981758641","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115774,"option_name":"Robert Mondavi Winery Sauvignon Blanc Stags Leap District Napa Valley 2019","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355981758641","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115774,"option_name":"Robert Mondavi Winery Sauvignon Blanc Stags Leap District Napa Valley 2019","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355981758641","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115774,"option_name":"Robert Mondavi Winery Sauvignon Blanc Stags Leap District Napa Valley 2019","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}],"discount_value":10,"discount_type":"percentage"}]},{"id":"6576002957489","abv":"13.5","purchase_terms":[]},{"id":"6576002859185","abv":"8","purchase_terms":[]},{"id":"6576002760881","abv":"14.5","purchase_terms":[]},{"id":"6576002728113","abv":"13.5","purchase_terms":[]},{"id":"6576002662577","abv":"14.5","purchase_terms":[]},{"id":"6576002629809","abv":"13.5","purchase_terms":[]},{"id":"6576002564273","abv":"14.5","purchase_terms":[]},{"id":"6576002465969","abv":"14.5","purchase_terms":[{"type":"buy_one_time","variant_id":"39355980284081","price":"40.00","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}]},{"type":"buy_one_time","variant_id":"39355980284081","price":"40.00","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}]},{"type":"buy_one_time","variant_id":"39355980284081","price":"40.00","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}]},{"type":"buy_one_time","variant_id":"39355980284081","price":"40.00","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}]},{"type":"subscription","variant_id":"39355980284081","price":40.0,"level_id":112222,"level_name":"Subscription","option_id":115771,"option_name":"Robert Mondavi Winery Fumé Blanc Oakville Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355980284081","price":40.0,"level_id":112222,"level_name":"Subscription","option_id":115771,"option_name":"Robert Mondavi Winery Fumé Blanc Oakville Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355980284081","price":40.0,"level_id":112222,"level_name":"Subscription","option_id":115771,"option_name":"Robert Mondavi Winery Fumé Blanc Oakville Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355980284081","price":40.0,"level_id":112222,"level_name":"Subscription","option_id":115771,"option_name":"Robert Mondavi Winery Fumé Blanc Oakville Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}],"discount_value":10,"discount_type":"percentage"}]},{"id":"6576002433201","abv":"14.5","purchase_terms":[{"type":"buy_one_time","variant_id":"39355980251313","price":"23.00","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}]},{"type":"buy_one_time","variant_id":"39355980251313","price":"23.00","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}]},{"type":"buy_one_time","variant_id":"39355980251313","price":"23.00","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}]},{"type":"buy_one_time","variant_id":"39355980251313","price":"23.00","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}]},{"type":"subscription","variant_id":"39355980251313","price":23.0,"level_id":112222,"level_name":"Subscription","option_id":115769,"option_name":"Robert Mondavi Winery Fumé Blanc Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355980251313","price":23.0,"level_id":112222,"level_name":"Subscription","option_id":115769,"option_name":"Robert Mondavi Winery Fumé Blanc Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355980251313","price":23.0,"level_id":112222,"level_name":"Subscription","option_id":115769,"option_name":"Robert Mondavi Winery Fumé Blanc Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355980251313","price":23.0,"level_id":112222,"level_name":"Subscription","option_id":115769,"option_name":"Robert Mondavi Winery Fumé Blanc Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}],"discount_value":10,"discount_type":"percentage"}]},{"id":"6576002400433","abv":"14.5","purchase_terms":[]},{"id":"6576002334897","abv":"13.5","purchase_terms":[]},{"id":"6576002203825","abv":"14.5","purchase_terms":[{"type":"buy_one_time","variant_id":"39355978907825","price":"34.00","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}]},{"type":"buy_one_time","variant_id":"39355978907825","price":"34.00","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}]},{"type":"buy_one_time","variant_id":"39355978907825","price":"34.00","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}]},{"type":"buy_one_time","variant_id":"39355978907825","price":"34.00","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}]},{"type":"subscription","variant_id":"39355978907825","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115772,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978907825","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115772,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978907825","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115772,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978907825","price":34.0,"level_id":112222,"level_name":"Subscription","option_id":115772,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Napa Valley 2018","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}],"discount_value":10,"discount_type":"percentage"}]},{"id":"6576002138289","abv":"14.5","purchase_terms":[]},{"id":"6576002105521","abv":"14.5","purchase_terms":[]},{"id":"6576002039985","abv":"15","purchase_terms":[]},{"id":"6576002007217","abv":"14.5","purchase_terms":[]},{"id":"6576001974449","abv":"14.5","purchase_terms":[]},{"id":"6576001941681","abv":"14.5","purchase_terms":[]},{"id":"6576001876145","abv":"14.5","purchase_terms":[{"type":"buy_one_time","variant_id":"39355978416305","price":"90.00","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}]},{"type":"buy_one_time","variant_id":"39355978416305","price":"90.00","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}]},{"type":"buy_one_time","variant_id":"39355978416305","price":"90.00","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}]},{"type":"buy_one_time","variant_id":"39355978416305","price":"90.00","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}]},{"type":"subscription","variant_id":"39355978416305","price":90.0,"level_id":112222,"level_name":"Subscription","option_id":115770,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Stags Leap District 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978416305","price":90.0,"level_id":112222,"level_name":"Subscription","option_id":115770,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Stags Leap District 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978416305","price":90.0,"level_id":112222,"level_name":"Subscription","option_id":115770,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Stags Leap District 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978416305","price":90.0,"level_id":112222,"level_name":"Subscription","option_id":115770,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Stags Leap District 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}],"discount_value":10,"discount_type":"percentage"}]},{"id":"6576001810609","abv":"14.5","purchase_terms":[{"type":"buy_one_time","variant_id":"39355978088625","price":"65.00","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}]},{"type":"buy_one_time","variant_id":"39355978088625","price":"65.00","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}]},{"type":"buy_one_time","variant_id":"39355978088625","price":"65.00","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}]},{"type":"buy_one_time","variant_id":"39355978088625","price":"65.00","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}]},{"type":"subscription","variant_id":"39355978088625","price":65.0,"level_id":112222,"level_name":"Subscription","option_id":115773,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Oakville Napa Valley 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":3,"quantity_presentment":[{"bottle":3}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978088625","price":65.0,"level_id":112222,"level_name":"Subscription","option_id":115773,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Oakville Napa Valley 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":6,"quantity_presentment":[{"bottle":6}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978088625","price":65.0,"level_id":112222,"level_name":"Subscription","option_id":115773,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Oakville Napa Valley 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":9,"quantity_presentment":[{"bottle":9}],"discount_value":10,"discount_type":"percentage"},{"type":"subscription","variant_id":"39355978088625","price":65.0,"level_id":112222,"level_name":"Subscription","option_id":115773,"option_name":"Robert Mondavi Winery Cabernet Sauvignon Oakville Napa Valley 2017","frequency_unit":"month","frequency_value":1,"frequency_label":"Subscribe Monthly","quantity_unit":"bottle","quantity":12,"quantity_presentment":[{"bottle":12}],"discount_value":10,"discount_type":"percentage"}]},{"id":"6576001745073","abv":"15","purchase_terms":[]},{"id":"6576001679537","abv":"15","purchase_terms":[]},{"id":"6576001646769","abv":"14.5","purchase_terms":[]},{"id":"6576001581233","abv":"14.5","purchase_terms":[]},{"id":"6576001548465","abv":"14.5","purchase_terms":[]},{"id":"6576001515697","abv":"14.5","purchase_terms":[]},{"id":"6576001482929","abv":"14.5","purchase_terms":[]},{"id":"6576001319089","abv":"14.5","purchase_terms":[]},{"id":"6576001286321","abv":"14.5","purchase_terms":[]},{"id":"6576001155249","abv":"14.5","purchase_terms":[]},{"id":"6576001056945","abv":"15","purchase_terms":[]},{"id":"6576000991409","abv":"14.4","purchase_terms":[]},{"id":"6576000860337","abv":"14.5","purchase_terms":[]},{"id":"6576000794801","abv":"14.5","purchase_terms":[]},{"id":"6576000729265","abv":"14.5","purchase_terms":[]},{"id":"6576000663729","abv":"14.5","purchase_terms":[]},{"id":"6576000565425","abv":"15.5","purchase_terms":[]},{"id":"6576000467121","abv":"14.5","purchase_terms":[]},{"id":"6576000434353","abv":"14.5","purchase_terms":[]},{"id":"6576000368817","abv":"15","purchase_terms":[]},{"id":"6576000270513","abv":"14.5","purchase_terms":[]},{"id":"6576000204977","abv":"13.7","purchase_terms":[]},{"id":"6576000106673","abv":"15.5","purchase_terms":[]},{"id":"6576000041137","abv":"15","purchase_terms":[]},{"id":"6575999975601","abv":"14.5","purchase_terms":[]}];

  var variants = {"6575999221937":[{"id":"39355971567793","quantity_unit":null,"base_container":null,"base_count":1,"price":0.0,"title":"Default Title"}],"6576000041137":[{"id":"39355975532721","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":172.5,"title":"Default Title"}],"6576000106673":[{"id":"39355975598257","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":90.0,"title":"Default Title"}],"6576000368817":[{"id":"39355975860401","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":172.5,"title":"Default Title"}],"6576000270513":[{"id":"39355975762097","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":50.0,"title":"Default Title"}],"6576000204977":[{"id":"39355975696561","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":100.0,"title":"Default Title"}],"6576000434353":[{"id":"39355975925937","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":125.0,"title":"Default Title"}],"6576000467121":[{"id":"39355975958705","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":50.0,"title":"Default Title"}],"6576000565425":[{"id":"39355976089777","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":90.0,"title":"Default Title"}],"6576000729265":[{"id":"39355976777905","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":50.0,"title":"Default Title"}],"6576000663729":[{"id":"39355976712369","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":100.0,"title":"Default Title"}],"6576000991409":[{"id":"39355977203889","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":50.0,"title":"Default Title"}],"6576000860337":[{"id":"39355976908977","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":55.0,"title":"Default Title"}],"6576000794801":[{"id":"39355976843441","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":80.0,"title":"Default Title"}],"6576001056945":[{"id":"39355977302193","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":175.0,"title":"Default Title"}],"6576001155249":[{"id":"39355977334961","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":125.0,"title":"Default Title"}],"6576001319089":[{"id":"39355977466033","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":90.0,"title":"Default Title"}],"6576001482929":[{"id":"39355977728177","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":55.0,"title":"Default Title"}],"6576001515697":[{"id":"39355977760945","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":100.0,"title":"Default Title"}],"6576001548465":[{"id":"39355977793713","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":67.5,"title":"Default Title"}],"6576001581233":[{"id":"39355977826481","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":60.0,"title":"Default Title"}],"6576001646769":[{"id":"39355977892017","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":67.5,"title":"Default Title"}],"6576001679537":[{"id":"39355977924785","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":175.0,"title":"Default Title"}],"6576001810609":[{"id":"39355978088625","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6576001745073":[{"id":"39355978055857","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6576001876145":[{"id":"39355978416305","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":90.0,"title":"Default Title"}],"6576001974449":[{"id":"39355978514609","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":50.0,"title":"Default Title"}],"6576001941681":[{"id":"39355978481841","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":55.0,"title":"Default Title"}],"6576002039985":[{"id":"39355978580145","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":57.0,"title":"Default Title"}],"6576002007217":[{"id":"39355978547377","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":60.0,"title":"Default Title"}],"6576002105521":[{"id":"39355978645681","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":175.0,"title":"Default Title"}],"6576002203825":[{"id":"39355978907825","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":34.0,"title":"Default Title"}],"6576002138289":[{"id":"39355978678449","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":55.0,"title":"Default Title"}],"6576002400433":[{"id":"39355980218545","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":55.0,"title":"Default Title"}],"6576002433201":[{"id":"39355980251313","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":23.0,"title":"Default Title"}],"6576002334897":[{"id":"39355979563185","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":24.0,"title":"Default Title"}],"6576002564273":[{"id":"39355980513457","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":29.0,"title":"Default Title"}],"6576002629809":[{"id":"39355980578993","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":28.0,"title":"Default Title"}],"6576002465969":[{"id":"39355980284081","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":40.0,"title":"Default Title"}],"6576002662577":[{"id":"39355980611761","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":57.0,"title":"Default Title"}],"6576002728113":[{"id":"39355980710065","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6576002760881":[{"id":"39355980742833","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":40.0,"title":"Default Title"}],"6576002859185":[{"id":"39355981529265","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":25.0,"title":"Default Title"}],"6576003023025":[{"id":"39355981758641","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":34.0,"title":"Default Title"}],"6576002957489":[{"id":"39355981627569","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":29.0,"title":"Default Title"}],"6576003088561":[{"id":"39355981889713","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":34.0,"title":"Default Title"}],"6610167726257":[{"id":"39444999176369","quantity_unit":null,"base_container":null,"base_count":1,"price":0.0,"title":"Moscato Mania"},{"id":"39445203681457","quantity_unit":null,"base_container":null,"base_count":1,"price":42.0,"title":"Collectors Club"}],"6624813744305":[{"id":"39514977796273","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":67.5,"title":"Default Title"}],"6628729323697":[{"id":"39528608399537","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":67.5,"title":"Default Title"}],"6576001286321":[{"id":"39671251206321","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6673414521009":[{"id":"39701916221617","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":50.0,"title":"Default Title"}],"6673445486769":[{"id":"39702093922481","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6673448894641":[{"id":"39702119612593","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":67.5,"title":"Default Title"}],"6673464754353":[{"id":"39702241509553","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6673532682417":[{"id":"39702638264497","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":65.0,"title":"Default Title"}],"6673555259569":[{"id":"39702771564721","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":55.0,"title":"Default Title"}],"6575999975601":[{"id":"39715547119793","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":100.0,"title":"Default Title"}],"6684285403313":[{"id":"39763023265969","quantity_unit":null,"base_container":null,"base_count":1,"price":99.0,"title":"Default Title"}],"6697795420337":[{"id":"39834896662705","quantity_unit":null,"base_container":null,"base_count":1,"price":65.0,"title":"Default Title"}],"6697815179441":[{"id":"39834996834481","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6697819668657":[{"id":"39835029864625","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6697823764657":[{"id":"39835056373937","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6697826222257":[{"id":"39835076919473","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6697836708017":[{"id":"39835147829425","quantity_unit":null,"base_container":null,"base_count":1,"price":34.0,"title":"Default Title"}],"6697839558833":[{"id":"39835159494833","quantity_unit":null,"base_container":null,"base_count":1,"price":29.0,"title":"Default Title"}],"6697843228849":[{"id":"39835193311409","quantity_unit":null,"base_container":null,"base_count":1,"price":67.5,"title":"Default Title"}],"6697845686449":[{"id":"39835207008433","quantity_unit":null,"base_container":null,"base_count":1,"price":50.0,"title":"Default Title"}],"6709212905649":[{"id":"39899608580273","quantity_unit":null,"base_container":null,"base_count":1,"price":15.0,"title":"Default Title"}],"6709401682097":[{"id":"39900553478321","quantity_unit":null,"base_container":null,"base_count":1,"price":0.0,"title":"Default Title"}],"6709485142193":[{"id":"39900996403377","quantity_unit":null,"base_container":null,"base_count":1,"price":34.0,"title":"Default Title"}],"6709492220081":[{"id":"39901030285489","quantity_unit":null,"base_container":null,"base_count":1,"price":24.0,"title":"Default Title"}],"6709496447153":[{"id":"39901048012977","quantity_unit":null,"base_container":null,"base_count":1,"price":34.0,"title":"Default Title"}],"6709501034673":[{"id":"39901069607089","quantity_unit":null,"base_container":null,"base_count":1,"price":34.0,"title":"Default Title"}],"6709511422129":[{"id":"39901122887857","quantity_unit":null,"base_container":null,"base_count":1,"price":29.0,"title":"Default Title"}],"6709514141873":[{"id":"39901145006257","quantity_unit":null,"base_container":null,"base_count":1,"price":25.0,"title":"Default Title"}],"6709521449137":[{"id":"39901185245361","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6709542158513":[{"id":"39901364420785","quantity_unit":null,"base_container":null,"base_count":1,"price":57.0,"title":"Default Title"}],"6709546877105":[{"id":"39901397614769","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":90.0,"title":"Default Title"}],"6709550809265":[{"id":"39901422911665","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6709555888305":[{"id":"39901450469553","quantity_unit":null,"base_container":null,"base_count":1,"price":67.5,"title":"Default Title"}],"6709563130033":[{"id":"39901494575281","quantity_unit":null,"base_container":null,"base_count":1,"price":125.0,"title":"Default Title"}],"6709591834801":[{"id":"39901689774257","quantity_unit":null,"base_container":null,"base_count":1,"price":125.0,"title":"Default Title"}],"6709655142577":[{"id":"39902353752241","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":325.0,"title":"Default Title"}],"6709656158385":[{"id":"39902369448113","quantity_unit":null,"base_container":null,"base_count":1,"price":55.0,"title":"Default Title"}],"6709658714289":[{"id":"39902395531441","quantity_unit":null,"base_container":null,"base_count":1,"price":40.0,"title":"Default Title"}],"6709659336881":[{"id":"39902401102001","quantity_unit":null,"base_container":null,"base_count":1,"price":50.0,"title":"Default Title"}],"6709660287153":[{"id":"39902404116657","quantity_unit":null,"base_container":null,"base_count":1,"price":50.0,"title":"Default Title"}],"6709660745905":[{"id":"39902410211505","quantity_unit":null,"base_container":null,"base_count":1,"price":50.0,"title":"Default Title"}],"6709662154929":[{"id":"39902424039601","quantity_unit":null,"base_container":null,"base_count":1,"price":325.0,"title":"Default Title"}],"6709670805681":[{"id":"39902520803505","quantity_unit":null,"base_container":null,"base_count":1,"price":28.0,"title":"Default Title"}],"6709671231665":[{"id":"39902527062193","quantity_unit":null,"base_container":null,"base_count":1,"price":28.0,"title":"Default Title"}],"6709671690417":[{"id":"39902534467761","quantity_unit":null,"base_container":null,"base_count":1,"price":28.0,"title":"Default Title"}],"6709672050865":[{"id":"39902541414577","quantity_unit":null,"base_container":null,"base_count":1,"price":50.0,"title":"Default Title"}],"6709673230513":[{"id":"39902547181745","quantity_unit":null,"base_container":null,"base_count":1,"price":67.5,"title":"Default Title"}],"6709674344625":[{"id":"39902555635889","quantity_unit":null,"base_container":null,"base_count":1,"price":29.0,"title":"Default Title"}],"6709674705073":[{"id":"39902561927345","quantity_unit":null,"base_container":null,"base_count":1,"price":29.0,"title":"Default Title"}],"6709675786417":[{"id":"39902568579249","quantity_unit":null,"base_container":null,"base_count":1,"price":90.0,"title":"Default Title"}],"6709676540081":[{"id":"39902576148657","quantity_unit":null,"base_container":null,"base_count":1,"price":67.5,"title":"Default Title"}],"6736874340529":[{"id":"40011136532657","quantity_unit":"set","base_container":"bottle","base_count":2,"price":150.0,"title":"Default Title"}],"6736875585713":[{"id":"40011139907761","quantity_unit":"bottle","base_container":"bottle","base_count":1,"price":200.0,"title":"Default Title"}],"6740547993777":[{"id":"40025386090673","quantity_unit":null,"base_container":null,"base_count":1,"price":160.0,"title":"Default Title"}],"6743770497201":[{"id":"40037107171505","quantity_unit":null,"base_container":null,"base_count":1,"price":160.0,"title":"Default Title"}],"6749365010609":[{"id":"40058476921009","quantity_unit":"set","base_container":"box","base_count":3,"price":160.0,"title":"Default Title"}],"6753819820209":[{"id":"40074022682801","quantity_unit":null,"base_container":null,"base_count":1,"price":34.0,"title":"Default Title"}]};

    var bloomfields = {"6753819820209":{"label_name":null},"6749365010609":{"label_name":"CONNOISSEUR GIFT SET"},"6743770497201":{"label_name":null},"6736875585713":{"label_name":"PRECISION GIFT SET"},"6736874340529":{"label_name":"EXCELLENCE GIFT SET"},"6709676540081":{"label_name":null},"6709675786417":{"label_name":null},"6709674705073":{"label_name":null},"6709674344625":{"label_name":null},"6709673230513":{"label_name":null},"6709672050865":{"label_name":null},"6709671690417":{"label_name":null},"6709671231665":{"label_name":null},"6709670805681":{"label_name":null},"6709662154929":{"label_name":null},"6709660745905":{"label_name":null},"6709660287153":{"label_name":null},"6709659336881":{"label_name":null},"6709658714289":{"label_name":null},"6709656158385":{"label_name":null},"6709655142577":{"label_name":null},"6709591834801":{"label_name":null},"6709563130033":{"label_name":null},"6709555888305":{"label_name":null},"6709550809265":{"label_name":null},"6709546877105":{"label_name":null},"6709542158513":{"label_name":null},"6709521449137":{"label_name":null},"6709514141873":{"label_name":null},"6709511422129":{"label_name":null},"6709501034673":{"label_name":null},"6709496447153":{"label_name":null},"6709485142193":{"label_name":null},"6709401682097":{"label_name":null},"6709212905649":{"label_name":null},"6697845686449":{"label_name":null},"6697843228849":{"label_name":null},"6697839558833":{"label_name":null},"6697836708017":{"label_name":null},"6697826222257":{"label_name":null},"6697823764657":{"label_name":null},"6697819668657":{"label_name":null},"6697815179441":{"label_name":null},"6697795420337":{"label_name":null},"6684285403313":{"label_name":null},"6673555259569":{"label_name":null},"6673532682417":{"label_name":null},"6673464754353":{"label_name":null},"6673448894641":{"label_name":null},"6673445486769":{"label_name":null},"6673414521009":{"label_name":null},"6624813744305":{"label_name":null},"6576003088561":{"label_name":null},"6576003023025":{"label_name":null},"6576002957489":{"label_name":null},"6576002859185":{"label_name":null},"6576002760881":{"label_name":null},"6576002728113":{"label_name":null},"6576002662577":{"label_name":null},"6576002629809":{"label_name":null},"6576002564273":{"label_name":null},"6576002465969":{"label_name":null},"6576002433201":{"label_name":null},"6576002400433":{"label_name":null},"6576002334897":{"label_name":null},"6576002203825":{"label_name":null},"6576002138289":{"label_name":null},"6576002105521":{"label_name":null},"6576002039985":{"label_name":null},"6576002007217":{"label_name":null},"6576001974449":{"label_name":null},"6576001941681":{"label_name":null},"6576001876145":{"label_name":null},"6576001810609":{"label_name":null},"6576001745073":{"label_name":null},"6576001679537":{"label_name":null},"6576001646769":{"label_name":null},"6576001581233":{"label_name":null},"6576001548465":{"label_name":null},"6576001515697":{"label_name":null},"6576001482929":{"label_name":null},"6576001319089":{"label_name":null},"6576001286321":{"label_name":null},"6576001155249":{"label_name":null},"6576001056945":{"label_name":null},"6576000991409":{"label_name":null},"6576000860337":{"label_name":null},"6576000794801":{"label_name":null},"6576000729265":{"label_name":null},"6576000663729":{"label_name":null},"6576000565425":{"label_name":null},"6576000467121":{"label_name":null},"6576000434353":{"label_name":null},"6576000368817":{"label_name":null},"6576000270513":{"label_name":null},"6576000204977":{"label_name":null},"6576000106673":{"label_name":null},"6576000041137":{"label_name":null},"6575999975601":{"label_name":null}}

    Bloom.storefront.data.products.forEach(function(product) {
        product.variants = variants[product.id];
        product.bloomfields = bloomfields[product.id];
    });

    var clubIndex, levelIindex;

    {%- for club in shop.metafields.bloom.clubs -%}
      {%- for club_field in club -%}
        {%- if club_field[0] == "id" -%}
          {%- assign club_id = club_field[1] -%}
        {%- endif -%}
        {%- if club_field[0] == "levels" -%}
          {%- assign levels = club_field[1] -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if levels -%}
        {%- for level in levels -%}
          {%- for level_field in level -%}
            {%- if level_field[0] == "id" -%}
              {%- assign level_id = level_field[1] -%}
              {%- assign level_name = "membership_level_" | append: level_id -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          clubIndex = Bloom.storefront.data.clubs.findIndex(function(c) { return c.id === {{ club_id }} });
          if (clubIndex !== -1) {
            levelIindex = (Bloom.storefront.data.clubs[clubIndex]||{}).levels.findIndex(function(l) { return l.id === {{ level_id }} });
            if (levelIindex !== -1) {
              (Bloom.storefront.data.clubs[clubIndex]||{}).levels[levelIindex] = {{ shop.metafields.bloom[level_name] | json }}
            }
          }
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
})()

window.Bloom.storefront.data.clubs = Bloom.storefront.utilities._.keysToCamel(window.Bloom.storefront.data.clubs);
window.Bloom.storefront.data.subscriptionVariants = Bloom.storefront.utilities._.keysToCamel(window.Bloom.storefront.data.subscriptionVariants);

Bloom.storefront.data.settings = Bloom.storefront.data.settings || {}
Bloom.storefront.data.settings.app_proxy_path = Bloom.storefront.data.settings.app_proxy_path || '/apps/wine-club'

Bloom.storefront.settings.clickEvents = ['click', 'mousedown', 'mouseup', 'dblclick']
Bloom.storefront.settings.dob = {
  show: {{ settings.bloom_cart_dob_show }},
  minimumAge: {{ settings.bloom_cart_dob_minimum_age }},
  cartAttributeName: "Customer date of birth"
}
Bloom.storefront.settings.cart = Bloom.storefront.settings.cart || Bloom.storefront.utilities._.keysToCamel(
  {})

Bloom.Cookie = function(name) {
  var current = new Date();
  var expiresAt = new Date(current.getFullYear(), current.getMonth() + 1, current.getDate())
  var json = {}

  var load = function() {
    try {
      return json = JSON.parse(atob(decodeURIComponent(docCookies.getItem(name))))
    } catch (e) {
      docCookies.removeItem(name)
      return json = {}
    }
  }

  var save = function() {
    docCookies.setItem(name, btoa(JSON.stringify(json)), expiresAt, null, null, true, 'none')
  }

  Object.assign(this, {
    getValue: function(key) {
      load()
      return json && json[key]
    },
    setValue: function(key, value, expiresAt) {
      load()
      json[key] = value
      save()
    },
    clear: function() {
      docCookies.removeItem(name)
    }
  })
}

</script>

<link href="{{ 'bloom-shopify.css' | asset_url }}" rel="stylesheet" type="text/css" media="all" />
<script  src="{{ 'bloom-shopify.js' | asset_url }}"></script>

<script type="text/javascript">

window.bloom = window.bloom || {}
var bloomShopify = new BloomShopify()
window.bloom = Object.assign(window.bloom, bloomShopify)
var bloomCart = bloomShopify.shoppingCart()

Bloom.storefront.utilities._.formatDateString = function(dateString) {
  if (!dateString || typeof dateString.padStart !== "function") { return dateString }
  formattedDateString = dateString.split('-').map(function(datePart) { return datePart.padStart(2, "0") }).join('-')
  var date = new Date(formattedDateString)
  if (date.toString() !== "Invalid Date") {
    return formattedDateString
  } else {
    return dateString
  }
}

Bloom.storefront.utilities._.setDob = function(dob) {
  var dobString = Bloom.storefront.utilities._.formatDateString(dob);
  var date = new Date(dobString||"");
  if (date.toString() !== "Invalid Date") {
    Bloom.storefront.state.dob = dobString;
  } else {
    Bloom.storefront.state.dob = "";
  }
}

Bloom.storefront.utilities._.getDobObject = function() {
  var dobString = Bloom.storefront.utilities._.formatDateString(Bloom.storefront.state.dob);
  var date = new Date(dobString);
  if (date.toString() !== "Invalid Date") {
    var splitDobString = dobString.split('-')
    if (splitDobString.length > 0) {
      return {
        date: date,
        dateString: dobString,
        year: splitDobString[0],
        month: splitDobString[1],
        day: splitDobString[2]
      }
    }
  } else {
    return {}
  }
}

Bloom.storefront.utilities._.dobIsValid = function() {
  var dob = Bloom.storefront.utilities._.getDobObject().date
  var legalAge = (new Date().setFullYear( new Date().getFullYear() - Bloom.storefront.settings.dob.minimumAge ))
  return dob < legalAge
}

Bloom.storefront.utilities._.saveDobToCart = function() {
  var dobString = Bloom.storefront.utilities._.getDobObject().dateString
  if (dobString) {
    var attributes = {}
    attributes[Bloom.storefront.settings.dob.cartAttributeName] = dobString
    fetch('/cart/update.js', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ attributes: attributes })
    });
  }
}

Bloom.storefront.utilities._.setDob("{{ cart.attributes['Customer date of birth'] }}")
Bloom.storefront.state.cartRequiresDob = false;

{% capture requires_dob %}{%- render 'bloom-requires-dob' -%}{% endcapture %}
{% assign stripped_requires_dob = requires_dob | strip %}
{% if stripped_requires_dob == 'true' %}{% assign requires_dob = true %}{% else %}{% assign requires_dob = false %}{% endif %}

{%- if requires_dob -%}
  Bloom.storefront.state.cartRequiresDob = true;
{%- endif -%}

Bloom.storefront.utilities.getJSON = function(url, successCallback, failCallback) {
  var request = new XMLHttpRequest();
  var errorMessage = "An unexpected error occured. Please try again later.";
  request.open('GET', url, true);
  request.onload = function() {
    var json = JSON.parse(request.responseText);
    if (request.status >= 200 && request.status < 400) {
      successCallback(json)
    } else {
      failCallback(json)
    }
  };
  request.onerror = function() {
    failCallback(errorMessage)
  };
  request.send();
};

Bloom.storefront.utilities.postFormData = function(url, data, successCallback, failCallback) {
  var request = new XMLHttpRequest();
  request.open('POST', url, true);
  request.onload = function() {
    var json = JSON.parse(request.responseText);
    if (request.status >= 200 && request.status < 400) {
      successCallback(json)
    } else {
      failCallback(json)
    }
  };
  request.onerror = function(error) {
    failCallback(error)
  };
  request.send(data);
}

Bloom.storefront.utilities._.getUrlParameter = function(name, url) {
  url = url || location.search;
  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
  var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
  var results = regex.exec(url);
  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};

Bloom.storefront.utilities._.toCamel = (s) => {
  return s.replace(/([-_][a-z0-9])/ig, ($1) => {
    return $1.toUpperCase()
      .replace('-', '')
      .replace('_', '');
  });
};

Bloom.storefront.utilities._.isObject = function (o) {
  return o === Object(o) && !Array.isArray(o) && typeof o !== 'function';
};

Bloom.storefront.utilities._.keysToCamel = function (o) {
  if (Bloom.storefront.utilities._.isObject(o)) {
    const n = {};

    Object.keys(o)
      .forEach((k) => {
        n[Bloom.storefront.utilities._.toCamel(k)] = Bloom.storefront.utilities._.keysToCamel(o[k]);
      });

    return n;
  } else if (Array.isArray(o)) {
    return o.map((i) => {
      return Bloom.storefront.utilities._.keysToCamel(i);
    });
  }

  return o;
};

Bloom.storefront.utilities._.generateHash = function() {
  var array = new Uint8Array(20);
  (window.crypto || window.msCrypto).getRandomValues(array);
  return Array.from(array, function(d) { return d.toString(16).padStart(2, "0") }).join('');
};

Bloom.storefront.utilities.addToCart = function(variantOrMembershipLevelId, quantity, properties, target) {
  variantOrMembershipLevelId = variantOrMembershipLevelId || ''
  quantity = quantity || 1
  properties = properties || {}
  target = target || 'cart'
  if (['cart', 'checkout', 'ajax_cart'].includes(target)) {
    return bloomCart.add([{ id: variantOrMembershipLevelId, quantity: quantity, properties: properties }]).then(function(response) {
      if (target === 'checkout') {
        bloom.goToBloomCheckout()
      } else if (target === 'ajax_cart') {
        bloom.openThemeAjaxCart({ variant: variantOrMembershipLevelId, quantity: quantity || 1 })
      } else {
        bloom.goToShopifyCart()
      }
    })
  } else {
    if (!Bloom.storefront.utilities._.recurringOptions) return
    var membershipLevel = Bloom.storefront.data.clubs.flatMap(function(c) { return c.levels }).find(function(l) { return l.id === parseInt(variantOrMembershipLevelId) })
    var selectionsAttributes = Bloom.storefront.utilities._.recurringOptions.membershipSelectionsForLineItemProperties(membershipLevel, properties, quantity)
    var bloomStorage = bloom.storage()
    var idempotencyKey = bloomStorage.getItem("membership.idempotencyKey") || Bloom.storefront.utilities._.generateHash()
    bloomStorage.setItem('membership', {
      membershipLevelId: variantOrMembershipLevelId,
      frequencyId: membershipLevel.frequencies[0].id,
      selectionsAttributes: selectionsAttributes,
      idempotencyKey: idempotencyKey
    })
    window.location = target
  }
}

Bloom.storefront.utilities._coverButton = function(button, i) {
  var checkoutButtonContainer = Bloom.storefront.utilities._.closestAncestor(button, '[data-bloom-checkout-container]');
  var checkoutBlocker;
  var buttonComputedStyles = window && window.getComputedStyle(button);
  var originalDisplay = button.style.display;
  if (!checkoutButtonContainer) {
    checkoutButtonContainer = document.createElement("span");
    checkoutButtonContainer.setAttribute('data-bloom-checkout-container', "");
    checkoutButtonContainer.style.position = 'relative';
    checkoutButtonContainer.style.display = buttonComputedStyles.display;
    checkoutButtonContainer.style.margin = buttonComputedStyles.margin;
    checkoutButtonContainer.style.width = button.style.width;
    checkoutBlocker = document.createElement("span");
    checkoutBlocker.setAttribute('data-bloom-checkout-blocker', "");
    checkoutBlocker.style.position = "absolute";
    checkoutBlocker.style.left = "0px";
    checkoutBlocker.style.top = "0px";
    checkoutBlocker.style.right = "0px";
    checkoutBlocker.style.bottom = "0px";
    checkoutBlocker.style.zIndex = "1";
    button.style.display = "none";
    button.style.margin = "0px";
    button.style.opacity = "0.3"
    button.insertAdjacentElement('afterend', checkoutButtonContainer);
    button.style.display = originalDisplay;
    checkoutButtonContainer.appendChild(button);
    checkoutButtonContainer.appendChild(checkoutBlocker);
  }
}

Bloom.storefront.utilities._uncoverButton = function(button, i) {
  var checkoutButtonContainer = Bloom.storefront.utilities._.closestAncestor(button, '[data-bloom-checkout-container]');
  if (checkoutButtonContainer) {
    checkoutButtonContainer.insertAdjacentElement('afterend', button);
    button.style.margin = checkoutButtonContainer.style.margin;
    button.style.opacity = "1"
    checkoutButtonContainer.parentNode.removeChild(checkoutButtonContainer);
  }
}

Bloom.storefront.utilities.disableCheckout = function() {
  console.log("Disabling checkout")
  Array.prototype.forEach.call(document.querySelectorAll('[name="checkout"]'), Bloom.storefront.utilities._coverButton)
  Array.prototype.forEach.call(document.querySelectorAll('[action*="checkout"] [type="submit"]'), Bloom.storefront.utilities._coverButton)
}

Bloom.storefront.utilities.enableCheckout = function() {
  console.log("Enabling checkout")
  Array.prototype.forEach.call(document.querySelectorAll('[name="checkout"]'), Bloom.storefront.utilities._uncoverButton)
  Array.prototype.forEach.call(document.querySelectorAll('[action*="checkout"] [type="submit"]'), Bloom.storefront.utilities._uncoverButton)
}

Bloom.storefront.utilities.cartItemHasAlcohol = function(item) {
  return !!parseInt((Bloom.storefront.data.products.find(function(p) { return p.id.toString() === item.product_id.toString() })||{}).abv)
}

Bloom.storefront.utilities.cartItemIsRecurring = function(item) {
  var clubNames = ["subscription"].concat(Bloom.storefront.data.clubs.map(function(c) { return c.name.toLowerCase() }))
  return clubNames.includes(item.product_title.toLowerCase()) || Object.keys(item.properties || []).some(function(p) { return clubNames.includes(p.toLowerCase()) })
}

Bloom.storefront.utilities.cartItemRequiresDob = function(item) {
  return Bloom.storefront.utilities.cartItemHasAlcohol(item) || Bloom.storefront.utilities.cartItemIsRecurring(item)
}

Bloom.storefront.utilities.cartRequiresDob = function(cart) {
  return !!cart.items.some(Bloom.storefront.utilities.cartItemRequiresDob)
}

Bloom.storefront.utilities._.checkoutIsBlocked = function() {
  return Bloom.storefront.settings.dob.show && Bloom.storefront.state.cartRequiresDob && !Bloom.storefront.utilities._.dobIsValid();
}

Bloom.storefront.utilities.renderCheckout = function() {
  Bloom.storefront.utilities._.ignoreDom()
  if (Bloom.storefront.utilities._.checkoutIsBlocked()) {
    Bloom.storefront.utilities.disableCheckout();
  } else {
    Bloom.storefront.utilities.enableCheckout();
  }
  Bloom.storefront.utilities._.observeDom()
}

Bloom.storefront.utilities._.initializeClubSignups = function(event) {
  var el = Bloom.storefront.utilities._.closestAncestor(event.target, '[data-bloom-club-signup]');
  var clubInput = el.querySelector('[data-bloom-club-signup-club]')
  var targetInput = el.querySelector('[data-bloom-club-signup-target]')
  var defaultVariantInput = el.querySelector('[data-bloom-club-signup-default-variant]')
  var levelInput = el.querySelector('[data-bloom-club-signup-level]')
  var variantInput = el.querySelector('[data-bloom-club-signup-variant]')
  var optionsInput = el.querySelector('[data-bloom-club-signup-variant]')
  var button = el.querySelector('[data-bloom-club-signup-button]')

  if (variantInput && variantInput.options) {
    var selectedLevelId = variantInput.options[variantInput.selectedIndex].dataset.bloomClubSignupOption;
    var options = Bloom.storefront.utilities.makeArray(el.querySelectorAll('[data-bloom-club-signup-options]')).forEach(function(optionsEl) {
      var isSelected = optionsEl.dataset.bloomClubSignupOptions === selectedLevelId
      if (isSelected) {
        optionsEl.style.display = "inherit"
      } else {
        optionsEl.style.display = "none"
      }
      Bloom.storefront.utilities.makeArray(optionsEl.querySelectorAll('input')).forEach(function(input) {
        input.disabled = !isSelected
        input.checked = false
      })
    })
  }

  button.addEventListener('click', function(event) {
    var options = []
    Bloom.storefront.utilities.makeArray(el.querySelectorAll('[data-bloom-club-signup-options-input]')).forEach(function(option) {
      if (option.checked) {
        options.push(option.value)
      }
    })
    var levelName = ((variantInput.options||[])[(variantInput.selectedIndex||0)]||{}).text || (levelInput||{}).value
    var variantId = variantInput.value || defaultVariantInput.value
    var properties = {}
    properties[clubInput.value] = levelName

    if (options.length > 0) {
      var keyName = 'Selection'
      if (options.length > 1) {
        keyName = keyName + 's'
      }
      properties[keyName] = options.join(', ')
    }

    Bloom.storefront.utilities.addToCart(variantId, 1, properties, targetInput.value)
  })
}

Bloom.storefront.utilities._.disableButton = function(button) {
  var spinner = document.createElement('span');
  spinner.classList.add("uk-vertical-align-middle");
  spinner.setAttribute('data-uk-spinner', '');
  spinner.style.marginLeft = "0.5em"
  button.parentNode.insertBefore(spinner, button.nextSibling);
  // HACK: Some forms rely on checking the value of the button that was clicked. Bizarrely,
  // Chrome doesn't include the buttons value in the POST request if you disable the button
  // on submit. We get around that here by setting a slight timeout before disabling.
  setTimeout(function() {
    button.disabled = true;
  })
}

Bloom.storefront.utilities._.enableButton = function(button) {
  Bloom.storefront.utilities.makeArray(button.parentNode.querySelectorAll('[data-uk-spinner]')).forEach(function(el) {
    el.parentNode.removeChild(el);
  })
  button.disabled = false;
}

Bloom.storefront.utilities._.handleClubSignupSubmit = function(event) {
  Bloom.storefront.utilities._.cancelEvent(event)
  var form = event.target
  var errorEl = form.querySelector('[data-bloom-club-signup-error]')
  var button = form.querySelector('[data-bloom-club-signup-button]')
  errorEl.style.display = "none";
  Bloom.storefront.utilities._.disableButton(button)
  var formData = new FormData(form);
  Bloom.storefront.utilities.postFormData(Bloom.storefront.data.settings.app_proxy_path + '/api/members', formData, function(response) {
    window.location = response.redirect_url
  }, function(error) {
    errorEl.innerHTML = error;
    errorEl.style.display = "block";
    Bloom.storefront.utilities._.enableButton(button)
  })
}

Bloom.storefront.utilities._.initializeDobSelectors = function() {
  Bloom.storefront.utilities.makeArray(document.querySelectorAll('[data-date-selector]')).forEach(function(el) {
    if (!Bloom.storefront.state.cartRequiresDob) {
      el.style.display = 'none';
    } else {
      el.style.display = 'inline-block';
    }
  })

  Bloom.storefront.utilities.renderCheckout();
}

Bloom.storefront.utilities._.handleDateInputChange = function(event) {
  var dateInputEl = Bloom.storefront.utilities._.closestAncestor(event.target, '[data-date-input]')
  var dateString = Bloom.storefront.utilities._.getDateInputValue(dateInputEl)
  Bloom.storefront.utilities._.setDob(dateString)
  Bloom.storefront.utilities._.saveDobToCart()
  Bloom.storefront.utilities._.renderDateInputs()
}

Bloom.storefront.utilities._.getDateInputValue = function(dateInputEl) {
  var dobMonthSelect = dateInputEl.querySelector('[data-date-input-select="month"]')
  var dobDaySelect = dateInputEl.querySelector('[data-date-input-select="day"]')
  var dobYearSelect = dateInputEl.querySelector('[data-date-input-select="year"]')

  if (!(dobMonthSelect && dobDaySelect && dobYearSelect)) return;

  var month = dobMonthSelect.options[dobMonthSelect.selectedIndex].value
  var day = dobDaySelect.options[dobDaySelect.selectedIndex].value
  var year = dobYearSelect.options[dobYearSelect.selectedIndex].value

  return year && month && day && Bloom.storefront.utilities._.formatDateString(year + '-' + month + '-' + day)
}

Bloom.storefront.utilities._.setDateInputNumberOfDays = function(dateInputEl) {
  Bloom.storefront.utilities._.ignoreDom()
  var dobMonthSelect = dateInputEl.querySelector('[data-date-input-select="month"]')
  var dobDaySelect = dateInputEl.querySelector('[data-date-input-select="day"]')
  var dobYearSelect = dateInputEl.querySelector('[data-date-input-select="year"]')

  if (!(dobMonthSelect && dobDaySelect && dobYearSelect)) return;

  var month = dobMonthSelect.options[dobMonthSelect.selectedIndex].value
  var day = dobDaySelect.options[dobDaySelect.selectedIndex].value
  var year = dobYearSelect.options[dobYearSelect.selectedIndex].value
  var currentDobString = year && month && day && (year + '-' + month + '-' + day)

  var currentDaysCount = dobDaySelect.querySelectorAll('option').length - 1
  var newDaysCount = new Date(year || new Date().getFullYear(), month || new Date().getMonth() + 1, 0).getDate()

  if (currentDaysCount !== newDaysCount) {
    dobDaySelect.innerHTML = '<option value="">Day</option>'
    for (i = 1; i <= newDaysCount; i++) {
      var option = document.createElement("option");
      option.value = i;
      option.text = i;
      if (i === parseInt(day)) {
        option.selected = true
      }
      dobDaySelect.appendChild(option);
    }
  }
  Bloom.storefront.utilities._.observeDom()
}

Bloom.storefront.utilities._.renderDateInputs = function() {
  var dateInputs = Bloom.storefront.utilities.makeArray(document.querySelectorAll('[data-date-input]'))
  dateInputs.forEach(Bloom.storefront.utilities._.setDateInputValue)
  dateInputs.forEach(Bloom.storefront.utilities._.setDateInputNumberOfDays)
}

Bloom.storefront.utilities._.setDateInputValue = function(dateInputEl) {
  var dobObject = Bloom.storefront.utilities._.getDobObject()
  if (dobObject.dateString) {
    var dobMonthSelect = dateInputEl.querySelector('[data-date-input-select="month"]')
    var dobDaySelect = dateInputEl.querySelector('[data-date-input-select="day"]')
    var dobYearSelect = dateInputEl.querySelector('[data-date-input-select="year"]')

    var dateElementMap = { year: dobYearSelect, month: dobMonthSelect, day: dobDaySelect }
    Object.keys(dateElementMap).forEach(function(dateElement) {
      var el = dateElementMap[dateElement]
      Bloom.storefront.utilities.makeArray(el.querySelectorAll('option')).forEach(function(option, i) {
        if (option.value.toString() === dobObject[dateElement].toString()) {
          el.selectedIndex = i
        }
      })
    })
  }
}

Bloom.storefront.utilities.domModified = Bloom.storefront.utilities.debounce(function() {
  Bloom.storefront.utilities.triggerCustomEvent(document, 'bloom:domModified', {})
});

Bloom.storefront.utilities._.getDiscountCodeForCart = function(cart) {
  if (!window.RecurringOptions) return;
  var discount = Bloom.storefront.utilities._.recurringOptions.discountForCustomerTagsAndLineItems(
    Bloom.storefront.data.customer.tags,
    cart.items,
    Bloom.storefront.data.settings.automatic_discount_codes
  )
  return (discount||{}).code
};

Bloom.storefront.utilities._.hasDiscountNinjaPromotion = function() {
  return (typeof discountNinja !== 'undefined') && discountNinja.DiscountedCart.GetAppliedPromotions().length
}

Bloom.storefront.utilities._.doNativeCheckout = function(cart) {
  var hasDiscountNinjaPromotion = Bloom.storefront.utilities._.hasDiscountNinjaPromotion()
  var cartHasRecurring = cart.items.some(Bloom.storefront.utilities.cartItemIsRecurring)
  return hasDiscountNinjaPromotion || (!Bloom.storefront.data.settings.always_use_bloom_checkout && !cartHasRecurring)
};

Bloom.storefront.utilities._.getCart = Bloom.storefront.utilities.debounce(function(successCallback) {
  return fetch('/cart.js')
    .then(function(response) {
      return response.json()
    })
    .then(function(data) {
      successCallback(data)
    });
});

Bloom.storefront.utilities.handleCheckoutClick = function(event) {
  if (Bloom.storefront.utilities._.checkoutIsBlocked() || !Bloom.storefront.utilities._.hasDiscountNinjaPromotion()) {
    Bloom.storefront.utilities._.cancelEvent(event)
  }
  Bloom.storefront.utilities._.getCart(function(cart) {
    var doNativeCheckout = Bloom.storefront.utilities._.doNativeCheckout(cart)
    if (!doNativeCheckout) {
      Bloom.storefront.utilities._.cancelEvent(event)
    }
    if (Bloom.storefront.utilities._.checkoutIsBlocked()) { return false }
    if (Bloom.storefront.utilities._.hasDiscountNinjaPromotion()) { return true }
    var form = Bloom.storefront.utilities._.closestAncestor(event.target, "form")
    var button = Bloom.storefront.utilities._.closestAncestor(event.target, "button")
    var discountCode = Bloom.storefront.utilities._.getUrlParameter("discount", form.action)
    if (!discountCode) {
      discountCode = Bloom.storefront.utilities._.getDiscountCodeForCart(cart)
    }
    ((event||{}).target||{}).disabled = true;
    (button||{}).disabled = true;
    try {
      Bloom.storefront.utilities.checkout(discountCode, { target: doNativeCheckout ? 'shopify' : 'bloom' })
    } catch (e) {
      ((event||{}).target||{}).disabled = false;
      (button||{}).disabled = false;
    }
  })
}

Bloom.storefront.utilities.checkout = function(discountCode, options) {
  options = Object.assign({ target: 'bloom' }, options)
  if (discountCode) {
    bloom.setDiscountCode(discountCode)
  }
  if (options.target === 'bloom') {
    bloom.goToBloomCheckout()
  } else {
    bloom.goToShopifyCheckout()
  }
}

Bloom.storefront.utilities._.domObserver = new MutationObserver(function(mutationsList, observer) {
  for(var i = 0; i < mutationsList.length; i++) {
    var mutation = mutationsList[i]
    // console.log(mutation)
    if (mutation.type === 'childList') {
      Bloom.storefront.utilities.domModified()
    }
  }
})

Bloom.storefront.utilities._.observeDom = function() {
  Bloom.storefront.utilities._.domObserver.observe(document, { childList: true, subtree: true });
}

Bloom.storefront.utilities._.ignoreDom = function() {
  Bloom.storefront.utilities._.domObserver.disconnect();
}

Bloom.storefront.utilities._.observeDom()

Bloom.storefront.utilities._.handleCheckoutClickEvents = function(el, i) {
  Bloom.storefront.settings.clickEvents.forEach(function(eventName) {
    el.addEventListener(eventName, Bloom.storefront.utilities.handleCheckoutClick)
  })
}

Bloom.storefront.utilities.ready(function() {
  Bloom.storefront.utilities.makeArray(document.querySelectorAll('[name="checkout"]')).forEach(Bloom.storefront.utilities._.handleCheckoutClickEvents);
  Bloom.storefront.utilities.makeArray(document.querySelectorAll('[action*="checkout"] [type="submit"]')).forEach(Bloom.storefront.utilities._.handleCheckoutClickEvents);

  Bloom.storefront.utilities.makeArray(document.querySelectorAll('[name="checkout_url"]')).forEach(function(el, i) {
    if (el.value.includes('checkout')) {
      el.value = '/cart';
    }
  });

  // Redirect back to cart after forgot password flow to ensure club member benefits are applied
  Bloom.storefront.utilities.makeArray(document.querySelectorAll("[action='/account/reset']")).forEach(function(el) {
    var input = document.createElement("input");
    input.setAttribute("type", "hidden");
    input.setAttribute("name", "return_to");
    input.setAttribute("value", new URL(window.location.href).searchParams.get("return_to") || "/cart");
    el.appendChild(input);
  });

  Bloom.storefront.utilities.domModified()

  if (window.RecurringOptions) {
    Bloom.storefront.utilities._.recurringOptions = new window.RecurringOptions(
      Bloom.storefront.data.clubs.filter(function(c) { return ["traditional", "allocation"].includes(c.clubType) }),
      Bloom.storefront.data.clubs.filter(function(c) { return ["subscription"].includes(c.clubType) }),
      Bloom.storefront.data.subscriptionVariants
    )
  }

  // Reattach after Age Gate loads because some clients are using the age gate in weird ways
  window.bloom = Object.assign(window.bloom, bloomShopify)
});

if (Bloom.storefront.data.settings.is_sales_channel) {
  Bloom.storefront.settings.clickEvents.forEach(function(eventName) {
    Bloom.storefront.utilities.addDelegatedEventListener(eventName, '[name="checkout"]', Bloom.storefront.utilities.handleCheckoutClick)
    Bloom.storefront.utilities.addDelegatedEventListener(eventName, '[action*="checkout"] [type="submit"]', Bloom.storefront.utilities.handleCheckoutClick)
  })
}

Bloom.storefront.utilities.addDelegatedEventListener('blur', '[data-date-input-select]', Bloom.storefront.utilities._.handleDateInputChange)
Bloom.storefront.utilities.addDelegatedEventListener('change', '[data-date-input-select]', Bloom.storefront.utilities._.handleDateInputChange)
Bloom.storefront.utilities.addDelegatedEventListener('blur', '[data-date-selector]', Bloom.storefront.utilities._.initializeDobSelectors)
Bloom.storefront.utilities.addDelegatedEventListener('change', '[data-date-selector]', Bloom.storefront.utilities._.initializeDobSelectors)

// Bloom.storefront.utilities.addDelegatedEventListener('blur', '[data-bloom-club-signup-variant]', Bloom.storefront.utilities._.initializeClubSignups)
// Bloom.storefront.utilities.addDelegatedEventListener('change', '[data-bloom-club-signup-variant]', Bloom.storefront.utilities._.initializeClubSignups)

Bloom.storefront.utilities.addDelegatedEventListener('submit', '[data-bloom-club-signup]', Bloom.storefront.utilities._.handleClubSignupSubmit)

Bloom.storefront.utilities.addDelegatedEventListener('click', '[data-bloom-click-disable]', function(event) { Bloom.storefront.utilities._.disableButton(event.target) })

Bloom.storefront.utilities.addDelegatedEventListener('change', '[name^="attributes"]', function(event) {
  var attributeName = event.target.getAttribute("name").substring(11, event.target.getAttribute("name").length-1);
  var request = new XMLHttpRequest();
  request.open('POST', '/cart/update.js', true);
  request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
  var hasFilledInGiftField = Array.from(document.querySelectorAll('[name^="attributes"]'))
  .some(function(a) {
      var attributeName = a.getAttribute('name').substring(11, a.getAttribute("name").length-1)
      return a.value && ['To', 'From', 'Gift message'].map(function (gF) { return gF.toLowerCase() }).includes(attributeName.toLowerCase())
    })
  var attributes = {}
  attributes[attributeName] = event.target.value
  attributes['Gift'] = hasFilledInGiftField ? 'Yes' : ''
  request.send(Object.keys(attributes).map(function(key) {
    return 'attributes[' + key + ']' + '=' + attributes[key].toString()
  }).join('&'));
})

document.addEventListener('bloom:domModified', function(e) {
  Bloom.storefront.utilities.getJSON('/cart.js', function(cart) {
    Bloom.storefront.state.cartRequiresDob = Bloom.storefront.utilities.cartRequiresDob(cart)
    Bloom.storefront.utilities._.setDob(cart.attributes["Customer date of birth"])

    Bloom.storefront.utilities._.renderDateInputs()
    Bloom.storefront.utilities._.initializeDobSelectors()
  }, function(error) {
    console.log(error)
  })
})

</script>

<style>
  .Bloom__DateOfBirth__Default .Bloom__DateInput--input_wrapper {
    display: inline-block;
  }

  .Bloom__DateOfBirth__Default select {
    min-width: 5.5em;
    padding: 8px 10px !important;
    line-height: 1.42 !important;
  }

  .Bloom__DateOfBirth__Default select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("https://bloomapp-production.herokuapp.com/assets/ico-select.svg");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
    text-indent: 0.01px;
    text-overflow: '';
    cursor: pointer;
  }

  {% assign possible_primary_button_background_setting_names = "button_background, color_button_bg, color_button" | split: ', ' %}
  {% assign possible_primary_button_foreground_setting_names = "button_text_color, color_button_text" | split: ', ' %}
  {% assign possible_secondary_button_background_setting_names = "secondary_button_background, button_text_color, color_button_text" | split: ', ' %}
  {% assign possible_secondary_button_foreground_setting_names = "secondary_button_text_color, button_background, color_button_bg, color_button" | split: ', ' %}

  {% for setting_name in possible_primary_button_background_setting_names %}
    {% if settings[setting_name] %}
      {% assign primary_button_background = settings[setting_name] %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% for setting_name in possible_primary_button_foreground_setting_names %}
    {% if settings[setting_name] %}
      {% assign primary_button_foreground = settings[setting_name] %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% for setting_name in possible_secondary_button_background_setting_names %}
    {% if settings[setting_name] %}
      {% assign secondary_button_background = settings[setting_name] %}
      {% break %}
    {% endif %}
  {% endfor %}

  {% for setting_name in possible_secondary_button_foreground_setting_names %}
    {% if settings[setting_name] %}
      {% assign secondary_button_foreground = settings[setting_name] %}
      {% break %}
    {% endif %}
  {% endfor %}

  .Bloom__Button--Primary, .uk-dialog .Bloom__Button--Primary, .Bloom__Button--Primary:hover {
    background-color: {{ primary_button_background }};
    border: 1px solid {{ primary_button_background }};
    color: {{ primary_button_foreground }};
  }
  .Bloom__Button--Secondary, .uk-dialog .Bloom__Button--Secondary, .Bloom__Button--Secondary:hover {
    background-color: {{ secondary_button_background }};
    border: 1px solid {{ secondary_button_background }};
    color: {{ secondary_button_foreground }};
  }
  .Bloom__Button--Inverted, .uk-dialog .Bloom__Button--Inverted, .Bloom__Button--Inverted:hover {
    background-color: {{ primary_button_foreground }};
    border: 1px solid {{ primary_button_background }};
    color: {{ primary_button_background }};
  }
</style>
